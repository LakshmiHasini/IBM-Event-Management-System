<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Log In - EventTribe</title>
    <link rel="stylesheet" href="./src/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />
</head>

<body>
    <main class="card-container">
        <div class="login-card">
            <h1 id="logo"><span>event</span><span class="bi bi-lightning-charge-fill"
                    style="font-size: 18px"></span><span>tribe</span></h1>
            <h1>Welcome!<br>What's your email?</h1>
            <form id="login-form" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <input type="email" id="email" placeholder="Email" required minlength="5" maxlength="100"
                        pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,4}$"
                        title="Please enter a valid email address (e.g. user@example.com)">
                    <span class="error-message" id="email-error"></span>
                </div>
                <div class="form-group">
                    <input type="password" id="password" placeholder="Password" required minlength="8" maxlength="50"
                        pattern="(?=.*\d)(?=.*[a-z])(?=.*[A-Z]).{8,}"
                        title="Must contain at least one number, one uppercase, one lowercase letter, and be at least 8 characters long">
                    <span class="error-message" id="password-error"></span>
                </div>
                <button type="submit" class="btn btn-primary">Continue</button>
            </form>
            <div class="signIn-other">
                <span>Or Sign In with</span>
                <br>
                <p>By clicking Continue or the Apple, Google, or Facebook icons, you agree to EventTribe's <a
                        href="./help.html">Terms of Service</a> and <a href="./help.html">Privacy Policy</a>.</p>
                <div>
                    <span class="bi bi-google"></span>
                    <span class="bi bi-facebook"></span>
                    <span class="bi bi-apple"></span>
                </div>
                <a href="./register.html">Don't have an account? Sign Up</a>
                <a href="./tickets.html">Need help finding your tickets?</a>
            </div>
        </div>
    </main>

    <script>
        // Email validation constraints
        const EMAIL_MIN_LENGTH = 5;
        const EMAIL_MAX_LENGTH = 100;

        // Password validation constraints
        const PASSWORD_MIN_LENGTH = 8;
        const PASSWORD_MAX_LENGTH = 50;

        function validateEmail(email) {
            // Trim whitespace
            email = email.trim();

            // Check length constraints
            if (email.length < EMAIL_MIN_LENGTH) {
                return { valid: false, message: `Email must be at least ${EMAIL_MIN_LENGTH} characters long` };
            }

            if (email.length > EMAIL_MAX_LENGTH) {
                return { valid: false, message: `Email must not exceed ${EMAIL_MAX_LENGTH} characters` };
            }

            // Check email format
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                return { valid: false, message: 'Please enter a valid email address (e.g., user@example.com)' };
            }

            // Check for valid domain (at least one dot after @)
            const parts = email.split('@');
            if (parts.length !== 2 || !parts[1].includes('.')) {
                return { valid: false, message: 'Email must have a valid domain (e.g., @example.com)' };
            }

            // Check domain has extension
            const domainParts = parts[1].split('.');
            if (domainParts.length < 2 || domainParts[domainParts.length - 1].length < 2) {
                return { valid: false, message: 'Email domain must have a valid extension (e.g., .com, .org)' };
            }

            return { valid: true };
        }

        function validatePassword(password) {
            // Check length constraints
            if (password.length < PASSWORD_MIN_LENGTH) {
                return { valid: false, message: `Password must be at least ${PASSWORD_MIN_LENGTH} characters long` };
            }

            if (password.length > PASSWORD_MAX_LENGTH) {
                return { valid: false, message: `Password must not exceed ${PASSWORD_MAX_LENGTH} characters` };
            }

            // Check for at least one letter
            const hasLetter = /[a-zA-Z]/.test(password);
            if (!hasLetter) {
                return { valid: false, message: 'Password must contain at least one letter' };
            }

            // Check for at least one number
            const hasNumber = /[0-9]/.test(password);
            if (!hasNumber) {
                return { valid: false, message: 'Password must contain at least one number' };
            }

            return { valid: true };
        }

        function handleLogin(event) {
            event.preventDefault();

            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const emailError = document.getElementById('email-error');
            const passwordError = document.getElementById('password-error');

            let isValid = true;

            // Clear previous errors
            emailError.textContent = '';
            passwordError.textContent = '';

            // Validate email
            const emailValidation = validateEmail(email);
            if (!emailValidation.valid) {
                emailError.textContent = emailValidation.message;
                emailError.style.color = '#e63946';
                isValid = false;
            }

            // Validate password
            const passwordValidation = validatePassword(password);
            if (!passwordValidation.valid) {
                passwordError.textContent = passwordValidation.message;
                passwordError.style.color = '#e63946';
                isValid = false;
            }

            if (isValid) {
                // Save login state
                localStorage.setItem('loggedIn', 'true');
                localStorage.setItem('userEmail', email);

                // Redirect to return URL or home
                const returnUrl = localStorage.getItem('loginReturn') || './index.html';
                localStorage.removeItem('loginReturn');
                window.location.href = returnUrl;
            }
        }

        // Real-time validation on input
        document.addEventListener('DOMContentLoaded', function () {
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');
            const emailError = document.getElementById('email-error');
            const passwordError = document.getElementById('password-error');

            // Email real-time validation
            emailInput.addEventListener('blur', function () {
                const email = this.value.trim();
                if (email.length > 0) {
                    const validation = validateEmail(email);
                    if (!validation.valid) {
                        emailError.textContent = validation.message;
                        emailError.style.color = '#e63946';
                    } else {
                        emailError.textContent = '';
                    }
                }
            });

            // Password real-time validation
            passwordInput.addEventListener('blur', function () {
                const password = this.value;
                if (password.length > 0) {
                    const validation = validatePassword(password);
                    if (!validation.valid) {
                        passwordError.textContent = validation.message;
                        passwordError.style.color = '#e63946';
                    } else {
                        passwordError.textContent = '';
                    }
                }
            });

            // Clear errors on input
            emailInput.addEventListener('input', function () {
                if (emailError.textContent) {
                    emailError.textContent = '';
                }
            });

            passwordInput.addEventListener('input', function () {
                if (passwordError.textContent) {
                    passwordError.textContent = '';
                }
            });
        });
    </script>
</body>

</html>